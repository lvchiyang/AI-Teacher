å½“ç„¶å¯ä»¥ï¼è¿™æ®µ Kotlin ä»£ç ä½¿ç”¨ `kotlinx.serialization.json` æ„å»ºäº†ä¸€ä¸ª **JSON Schema** å¯¹è±¡ï¼Œç”¨äºæè¿° MCPï¼ˆModel Context Protocolï¼‰å·¥å…·çš„è¾“å…¥å‚æ•°æ ¼å¼ã€‚å®ƒçš„ä½œç”¨æ˜¯å‘Šè¯‰ **LLM Hostï¼ˆè°ƒç”¨æ–¹ï¼‰**ï¼šâ€œå¦‚æœä½ æƒ³è°ƒç”¨è¿™ä¸ªå·¥å…·ï¼Œå¿…é¡»æŒ‰è¿™ä¸ªç»“æ„ä¼ å‚æ•°â€ã€‚

æˆ‘ä»¬é€å±‚æ‹†è§£å¹¶è§£é‡Šå…¶å«ä¹‰ã€‚

---

### ğŸ¯ æ•´ä½“ç›®æ ‡

å®šä¹‰ä¸€ä¸ªå·¥å…·ï¼ˆæ¯”å¦‚å« `add`ï¼‰çš„è¾“å…¥å‚æ•°è§„èŒƒï¼Œç­‰ä»·äºä»¥ä¸‹ **JSON Schema**ï¼š

```json
{
  "type": "object",
  "properties": {
    "a": {
      "type": "number",
      "description": "ç¬¬ä¸€ä¸ªæ•°å­—"
    },
    "b": {
      "type": "number",
      "description": "ç¬¬äºŒä¸ªæ•°å­—"
    }
  },
  "required": ["a", "b"]
}
```

è¿™ä¸ª Schema è¡¨ç¤ºï¼š
- è¾“å…¥å¿…é¡»æ˜¯ä¸€ä¸ª **å¯¹è±¡ï¼ˆobjectï¼‰**
- å¯¹è±¡å¿…é¡»åŒ…å«å­—æ®µ `a` å’Œ `b`
- `a` å’Œ `b` éƒ½å¿…é¡»æ˜¯ **æ•°å­—ï¼ˆnumberï¼‰**
- è°ƒç”¨æ—¶ **å¿…é¡»æä¾›è¿™ä¸¤ä¸ªå­—æ®µ**ï¼ˆå› ä¸ºå®ƒä»¬åœ¨ `required` åˆ—è¡¨ä¸­ï¼‰

---

### ğŸ” é€è¡Œè¯¦è§£ï¼ˆKotlin ä»£ç ï¼‰

#### 1. å¤–å±‚ï¼š`inputSchema = buildJsonObject { ... }`
```kotlin
inputSchema = buildJsonObject {
```
- `buildJsonObject { ... }` æ˜¯ `kotlinx.serialization` æä¾›çš„ DSLï¼Œç”¨äºæ„å»º `JsonObject`ã€‚
- è¿™ä¸ªå¯¹è±¡å°†ä½œä¸ºå·¥å…·çš„ **è¾“å…¥å‚æ•°è§„èŒƒï¼ˆJSON Schemaï¼‰** ä¼ é€’ç»™ Hostã€‚
- Hostï¼ˆé€šå¸¸æ˜¯ LLMï¼‰ä¼šæ ¹æ®è¿™ä¸ª Schema å†³å®šå¦‚ä½•ç”Ÿæˆå·¥å…·è°ƒç”¨çš„å‚æ•°ã€‚

---

#### 2. æŒ‡å®šæ ¹ç±»å‹ï¼š`put("type", "object")`
```kotlin
    put("type", "object")
```
- è¡¨ç¤ºæ•´ä¸ªè¾“å…¥æ˜¯ä¸€ä¸ª **JSON å¯¹è±¡**ï¼ˆå³ `{}`ï¼‰ã€‚
- è¿™æ˜¯ JSON Schema çš„æ ‡å‡†å­—æ®µã€‚
- å…¶ä»–å¯èƒ½å€¼ï¼š`"string"`ã€`"number"`ã€`"array"`ã€`"boolean"` ç­‰ã€‚

> âœ… å¯¹åº” JSONï¼š
> ```json
> { "type": "object" }
> ```

---

#### 3. å®šä¹‰å­—æ®µç»“æ„ï¼š`put("properties", buildJsonObject { ... })`
```kotlin
    put("properties", buildJsonObject {
        put("a", buildJsonObject {
            put("type", "number")
            put("description", "ç¬¬ä¸€ä¸ªæ•°å­—")
        })
        put("b", buildJsonObject {
            put("type", "number")
            put("description", "ç¬¬äºŒä¸ªæ•°å­—")
        })
    })
```

- `properties` æ˜¯ JSON Schema çš„å…³é”®å­—ï¼Œç”¨äºå®šä¹‰å¯¹è±¡ä¸­ **æ¯ä¸ªå­—æ®µçš„ç±»å‹å’Œæè¿°**ã€‚
- è¿™é‡Œå®šä¹‰äº†ä¸¤ä¸ªå­—æ®µï¼š`a` å’Œ `b`ã€‚
- æ¯ä¸ªå­—æ®µæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª `JsonObject`ï¼ŒåŒ…å«ï¼š
  - `"type": "number"` â†’ è¯¥å­—æ®µå¿…é¡»æ˜¯æ•°å­—ï¼ˆæ”¯æŒæ•´æ•°å’Œæµ®ç‚¹æ•°ï¼‰
  - `"description": "..."` â†’ äººç±»å¯è¯»çš„è¯´æ˜ï¼Œå¸®åŠ© LLM ç†è§£å­—æ®µç”¨é€”

> âœ… å¯¹åº” JSONï¼š
> ```json
> "properties": {
>   "a": { "type": "number", "description": "ç¬¬ä¸€ä¸ªæ•°å­—" },
>   "b": { "type": "number", "description": "ç¬¬äºŒä¸ªæ•°å­—" }
> }
> ```

---

#### 4. å£°æ˜å¿…å¡«å­—æ®µï¼š`put("required", buildJsonArray { ... })`
```kotlin
    put("required", buildJsonArray { add("a"); add("b") })
```

- `required` æ˜¯ JSON Schema çš„å…³é”®å­—ï¼Œåˆ—å‡º **å¿…é¡»æä¾›çš„å­—æ®µå**ã€‚
- `buildJsonArray { add("a"); add("b") }` æ„å»ºä¸€ä¸ª JSON æ•°ç»„ï¼š`["a", "b"]`
- å¦‚æœè°ƒç”¨æ—¶ç¼ºå°‘ `a` æˆ– `b`ï¼ŒMCP Host æˆ– Server å¯ä»¥æ‹’ç»è¯·æ±‚ï¼ˆæˆ– LLM æ ¹æœ¬ä¸ä¼šç”Ÿæˆç¼ºå¤±å‚æ•°çš„è°ƒç”¨ï¼‰

> âœ… å¯¹åº” JSONï¼š
> ```json
> "required": ["a", "b"]
> ```

---

### ğŸ§  ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ª Schemaï¼Ÿ

1. **æŒ‡å¯¼ LLM ç”Ÿæˆæ­£ç¡®å‚æ•°**  
   LLMï¼ˆå¦‚ Qwenã€GPTï¼‰çœ‹åˆ°è¿™ä¸ª Schema åï¼Œå°±çŸ¥é“è°ƒç”¨ `add` å·¥å…·æ—¶å¿…é¡»ç”Ÿæˆç±»ä¼¼è¿™æ ·çš„å‚æ•°ï¼š
   ```json
   { "a": 10, "b": 20 }
   ```

2. **Host å¯åšå‚æ•°æ ¡éªŒ**  
   Host åœ¨å‘é€ `callTool` è¯·æ±‚å‰ï¼Œå¯ä»¥ç”¨è¿™ä¸ª Schema éªŒè¯å‚æ•°æ˜¯å¦åˆæ³•ã€‚

3. **å¼€å‘è€…æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ**  
   å·¥å…·åˆ—è¡¨æ¥å£ï¼ˆ`tools/list`ï¼‰ä¼šè¿”å›è¿™ä¸ª Schemaï¼Œå¯ç”¨äºç”Ÿæˆ API æ–‡æ¡£ã€‚

4. **å…¼å®¹ OpenAI Function Calling**  
   MCP çš„å·¥å…· Schema è®¾è®¡ä¸ OpenAI çš„ `function.parameters` å®Œå…¨å…¼å®¹ã€‚

---

### ğŸ›  å®é™…è°ƒç”¨ç¤ºä¾‹

å½“ Host è°ƒç”¨ä½ çš„ `add` å·¥å…·æ—¶ï¼Œä¼šå‘é€ç±»ä¼¼è¯·æ±‚ï¼š

```json
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": {
    "name": "add",
    "arguments": {
      "a": 3.14,
      "b": 2
    }
  }
}
```

ä½ çš„ Server ä»£ç ä¸­ï¼š
```kotlin
val a = request.arguments["a"]?.jsonPrimitive?.doubleOrNull // 3.14
val b = request.arguments["b"]?.jsonPrimitive?.doubleOrNull // 2.0
```

---

### ğŸ“Œ å°è´´å£«ï¼šå…¶ä»–å¸¸è§ç±»å‹ç¤ºä¾‹

#### å­—ç¬¦ä¸²å‚æ•°
```kotlin
put("city", buildJsonObject {
    put("type", "string")
    put("description", "åŸå¸‚åç§°")
})
```

#### å¸ƒå°”å€¼
```kotlin
put("verbose", buildJsonObject {
    put("type", "boolean")
    put("description", "æ˜¯å¦è¿”å›è¯¦ç»†ä¿¡æ¯"
})
```

#### æ•°ç»„
```kotlin
put("tags", buildJsonObject {
    put("type", "array")
    put("items", buildJsonObject { put("type", "string") })
    put("description", "æ ‡ç­¾åˆ—è¡¨")
})
```

---

### âœ… æ€»ç»“

| ä»£ç ç‰‡æ®µ | ä½œç”¨ |
|--------|------|
| `put("type", "object")` | è¾“å…¥æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ |
| `properties` | å®šä¹‰å¯¹è±¡ä¸­æ¯ä¸ªå­—æ®µçš„ç±»å‹å’Œè¯´æ˜ |
| `required` | å£°æ˜å“ªäº›å­—æ®µæ˜¯å¿…é¡»æä¾›çš„ |
| `buildJsonObject` / `buildJsonArray` | Kotlin DSLï¼Œç”¨äºæ„å»º JSON ç»“æ„ |

è¿™ä¸ª Schema æ˜¯ **MCP å·¥å…·çš„æ ¸å¿ƒå¥‘çº¦**ï¼Œç¡®ä¿ LLMã€Hostã€Server ä¸‰æ–¹å¯¹â€œå¦‚ä½•è°ƒç”¨å·¥å…·â€è¾¾æˆä¸€è‡´ã€‚

å¦‚æœä½ éœ€è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ªæ›´å¤æ‚çš„ Schemaï¼ˆæ¯”å¦‚åµŒå¥—å¯¹è±¡ã€æšä¸¾ã€é»˜è®¤å€¼ç­‰ï¼‰ï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ï¼