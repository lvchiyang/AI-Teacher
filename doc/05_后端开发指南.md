# AI教师系统后端开发指南

## 1. 开发环境搭建

### 1.1 开发工具
- **JDK**：OpenJDK 17
- **IDE**：IntelliJ IDEA 2023.3+
- **Maven**：3.9.0+
- **MySQL**：8.0+
- **Redis**：7.0+
- **Docker**：24.0+

### 1.2 项目配置
```xml
<!-- pom.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.1.0</version>
        <relativePath/>
    </parent>
    
    <groupId>com.aiteacher</groupId>
    <artifactId>ai-teacher-backend</artifactId>
    <version>1.0.0</version>
    <packaging>jar</packaging>
    
    <properties>
        <java.version>17</java.version>
        <spring-cloud.version>2022.0.3</spring-cloud.version>
    </properties>
    
    <dependencies>
        <!-- Spring Boot Starters -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        
        <!-- Database -->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>8.0.33</version>
        </dependency>
        
        <!-- JWT -->
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-api</artifactId>
            <version>0.11.5</version>
        </dependency>
        
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-impl</artifactId>
            <version>0.11.5</version>
        </dependency>
        
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-jackson</artifactId>
            <version>0.11.5</version>
        </dependency>
        
        <!-- Documentation -->
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
            <version>2.1.0</version>
        </dependency>
        
        <!-- Testing -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

### 1.3 项目结构
```
src/main/java/com/aiteacher/
├── AITeacherApplication.java          # 启动类
├── config/                            # 配置类
│   ├── SecurityConfig.java
│   ├── DatabaseConfig.java
│   └── RedisConfig.java
├── controller/                        # 控制器
│   ├── AuthController.java
│   ├── LearningController.java
│   ├── AIController.java
│   └── ParentController.java
├── service/                           # 服务层
│   ├── AuthService.java
│   ├── LearningService.java
│   ├── AIService.java
│   └── NotificationService.java
├── repository/                        # 数据访问层
│   ├── UserRepository.java
│   ├── LearningRecordRepository.java
│   └── QuestionRepository.java
├── entity/                            # 实体类
│   ├── User.java
│   ├── LearningRecord.java
│   └── Question.java
├── dto/                               # 数据传输对象
│   ├── request/
│   └── response/
├── security/                          # 安全相关
│   ├── JwtUtil.java
│   ├── JwtAuthenticationFilter.java
│   └── UserDetailsServiceImpl.java
├── exception/                         # 异常处理
│   ├── GlobalExceptionHandler.java
│   └── CustomException.java
└── utils/                            # 工具类
    ├── Constants.java
    └── Validators.java
```

## 2. 核心功能实现

### 2.1 用户认证模块

#### 2.1.1 实体类
```java
// entity/User.java
@Entity
@Table(name = "users")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;
    
    @Column(unique = true, nullable = false)
    private String username;
    
    @Column(unique = true, nullable = false)
    private String email;
    
    @Column(nullable = false)
    private String passwordHash;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private UserType userType;
    
    @Column(name = "profile_data", columnDefinition = "JSON")
    private String profileData;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
        updatedAt = LocalDateTime.now();
    }
    
    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }
}

// entity/UserProfile.java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class UserProfile {
    private String name;
    private String avatar;
    private String grade;
    private String school;
    private String phone;
    private String address;
}

// enum/UserType.java
public enum UserType {
    STUDENT, PARENT, TEACHER
}
```

#### 2.1.2 Repository
```java
// repository/UserRepository.java
@Repository
public interface UserRepository extends JpaRepository<User, String> {
    Optional<User> findByUsername(String username);
    Optional<User> findByEmail(String email);
    boolean existsByUsername(String username);
    boolean existsByEmail(String email);
    
    @Query("SELECT u FROM User u WHERE u.userType = :userType")
    List<User> findByUserType(@Param("userType") UserType userType);
}
```

#### 2.1.3 Service
```java
// service/AuthService.java
@Service
@Transactional
public class AuthService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public AuthResponseDTO login(LoginRequestDTO request) {
        // 验证用户
        User user = userRepository.findByUsername(request.getUsername())
            .orElseThrow(() -> new CustomException("用户不存在"));
        
        if (!passwordEncoder.matches(request.getPassword(), user.getPasswordHash())) {
            throw new CustomException("密码错误");
        }
        
        // 生成JWT token
        String token = jwtUtil.generateToken(user);
        
        // 将token存储到Redis
        redisTemplate.opsForValue().set(
            "token:" + user.getId(), 
            token, 
            Duration.ofHours(24)
        );
        
        return AuthResponseDTO.builder()
            .token(token)
            .user(convertToUserDTO(user))
            .expiresIn(24 * 60 * 60) // 24小时
            .build();
    }
    
    public UserDTO register(RegisterRequestDTO request) {
        // 检查用户名和邮箱是否已存在
        if (userRepository.existsByUsername(request.getUsername())) {
            throw new CustomException("用户名已存在");
        }
        
        if (userRepository.existsByEmail(request.getEmail())) {
            throw new CustomException("邮箱已存在");
        }
        
        // 创建新用户
        User user = new User();
        user.setUsername(request.getUsername());
        user.setEmail(request.getEmail());
        user.setPasswordHash(passwordEncoder.encode(request.getPassword()));
        user.setUserType(request.getUserType());
        
        // 设置用户资料
        UserProfile profile = new UserProfile();
        profile.setName(request.getName());
        profile.setGrade(request.getGrade());
        profile.setSchool(request.getSchool());
        
        user.setProfileData(JsonUtils.toJson(profile));
        
        user = userRepository.save(user);
        
        return convertToUserDTO(user);
    }
    
    public void logout(String userId) {
        // 从Redis中删除token
        redisTemplate.delete("token:" + userId);
    }
    
    public String refreshToken(String userId) {
        User user = userRepository.findById(userId)
            .orElseThrow(() -> new CustomException("用户不存在"));
        
        String newToken = jwtUtil.generateToken(user);
        
        // 更新Redis中的token
        redisTemplate.opsForValue().set(
            "token:" + userId, 
            newToken, 
            Duration.ofHours(24)
        );
        
        return newToken;
    }
    
    private UserDTO convertToUserDTO(User user) {
        UserProfile profile = JsonUtils.fromJson(user.getProfileData(), UserProfile.class);
        
        return UserDTO.builder()
            .id(user.getId())
            .username(user.getUsername())
            .email(user.getEmail())
            .userType(user.getUserType())
            .profile(profile)
            .createdAt(user.getCreatedAt())
            .build();
    }
}
```

#### 2.1.4 Controller
```java
// controller/AuthController.java
@RestController
@RequestMapping("/api/auth")
@Validated
public class AuthController {
    
    @Autowired
    private AuthService authService;
    
    @PostMapping("/login")
    public ResponseEntity<AuthResponseDTO> login(@Valid @RequestBody LoginRequestDTO request) {
        AuthResponseDTO response = authService.login(request);
        return ResponseEntity.ok(response);
    }
    
    @PostMapping("/register")
    public ResponseEntity<UserDTO> register(@Valid @RequestBody RegisterRequestDTO request) {
        UserDTO user = authService.register(request);
        return ResponseEntity.ok(user);
    }
    
    @PostMapping("/logout")
    public ResponseEntity<Void> logout(@RequestHeader("Authorization") String token) {
        String userId = jwtUtil.getUserIdFromToken(token);
        authService.logout(userId);
        return ResponseEntity.ok().build();
    }
    
    @PostMapping("/refresh")
    public ResponseEntity<RefreshTokenResponseDTO> refreshToken(
            @RequestHeader("Authorization") String token) {
        String userId = jwtUtil.getUserIdFromToken(token);
        String newToken = authService.refreshToken(userId);
        
        RefreshTokenResponseDTO response = RefreshTokenResponseDTO.builder()
            .token(newToken)
            .expiresIn(24 * 60 * 60)
            .build();
        
        return ResponseEntity.ok(response);
    }
}
```

### 2.2 学习模块

#### 2.2.1 实体类
```java
// entity/LearningPlan.java
@Entity
@Table(name = "learning_plans")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class LearningPlan {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;
    
    @Column(nullable = false)
    private String studentId;
    
    @Column(nullable = false)
    private String subject;
    
    @Column(nullable = false)
    private String gradeLevel;
    
    @Column(name = "plan_data", columnDefinition = "JSON")
    private String planData;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private PlanStatus status;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
        updatedAt = LocalDateTime.now();
    }
    
    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }
}

// entity/Lesson.java
@Entity
@Table(name = "lessons")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Lesson {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;
    
    @Column(nullable = false)
    private String title;
    
    @Column(columnDefinition = "TEXT")
    private String content;
    
    @Column(name = "lesson_data", columnDefinition = "JSON")
    private String lessonData;
    
    @Column(nullable = false)
    private Integer duration; // 分钟
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
    }
}

// entity/LearningRecord.java
@Entity
@Table(name = "learning_records")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class LearningRecord {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;
    
    @Column(nullable = false)
    private String studentId;
    
    @Column(nullable = false)
    private String lessonId;
    
    @Column(name = "start_time", nullable = false)
    private LocalDateTime startTime;
    
    @Column(name = "end_time")
    private LocalDateTime endTime;
    
    @Column(nullable = false)
    private Float progress;
    
    @Column
    private Float score;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private RecordStatus status;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
    }
}
```

#### 2.2.2 Repository
```java
// repository/LearningPlanRepository.java
@Repository
public interface LearningPlanRepository extends JpaRepository<LearningPlan, String> {
    List<LearningPlan> findByStudentIdAndStatus(String studentId, PlanStatus status);
    
    @Query("SELECT lp FROM LearningPlan lp WHERE lp.studentId = :studentId AND lp.subject = :subject")
    Optional<LearningPlan> findByStudentIdAndSubject(@Param("studentId") String studentId, 
                                                     @Param("subject") String subject);
}

// repository/LearningRecordRepository.java
@Repository
public interface LearningRecordRepository extends JpaRepository<LearningRecord, String> {
    List<LearningRecord> findByStudentIdOrderByStartTimeDesc(String studentId);
    
    @Query("SELECT lr FROM LearningRecord lr WHERE lr.studentId = :studentId AND lr.status = :status")
    List<LearningRecord> findByStudentIdAndStatus(@Param("studentId") String studentId, 
                                                   @Param("status") RecordStatus status);
    
    @Query("SELECT AVG(lr.score) FROM LearningRecord lr WHERE lr.studentId = :studentId AND lr.score IS NOT NULL")
    Optional<Double> getAverageScoreByStudentId(@Param("studentId") String studentId);
}
```

#### 2.2.3 Service
```java
// service/LearningService.java
@Service
@Transactional
public class LearningService {
    
    @Autowired
    private LearningPlanRepository learningPlanRepository;
    
    @Autowired
    private LearningRecordRepository learningRecordRepository;
    
    @Autowired
    private LessonRepository lessonRepository;
    
    @Autowired
    private AIService aiService;
    
    public LearningPlanDTO getLearningPlan(String studentId) {
        // 获取学生的学习计划
        List<LearningPlan> plans = learningPlanRepository.findByStudentIdAndStatus(
            studentId, PlanStatus.ACTIVE);
        
        if (plans.isEmpty()) {
            // 如果没有学习计划，生成一个新的
            return generateNewLearningPlan(studentId);
        }
        
        LearningPlan plan = plans.get(0);
        return convertToLearningPlanDTO(plan);
    }
    
    public LessonDTO startLesson(StartLessonRequestDTO request) {
        // 验证课程是否存在
        Lesson lesson = lessonRepository.findById(request.getLessonId())
            .orElseThrow(() -> new CustomException("课程不存在"));
        
        // 创建学习记录
        LearningRecord record = new LearningRecord();
        record.setStudentId(request.getStudentId());
        record.setLessonId(request.getLessonId());
        record.setStartTime(LocalDateTime.now());
        record.setProgress(0.0f);
        record.setStatus(RecordStatus.IN_PROGRESS);
        
        learningRecordRepository.save(record);
        
        return convertToLessonDTO(lesson);
    }
    
    public AnswerResultDTO submitAnswer(SubmitAnswerRequestDTO request) {
        // 获取学习记录
        LearningRecord record = learningRecordRepository.findById(request.getRecordId())
            .orElseThrow(() -> new CustomException("学习记录不存在"));
        
        // 使用AI服务评估答案
        AnswerEvaluationResult evaluation = aiService.evaluateAnswer(
            request.getQuestion(), 
            request.getAnswer()
        );
        
        // 更新学习记录
        record.setProgress(calculateProgress(record, evaluation));
        record.setScore(evaluation.getScore());
        
        if (record.getProgress() >= 100.0f) {
            record.setStatus(RecordStatus.COMPLETED);
            record.setEndTime(LocalDateTime.now());
        }
        
        learningRecordRepository.save(record);
        
        return AnswerResultDTO.builder()
            .isCorrect(evaluation.isCorrect())
            .score(evaluation.getScore())
            .explanation(evaluation.getExplanation())
            .suggestions(evaluation.getSuggestions())
            .build();
    }
    
    public LearningProgressDTO getLearningProgress(String studentId) {
        List<LearningRecord> records = learningRecordRepository.findByStudentIdOrderByStartTimeDesc(studentId);
        
        // 计算学习进度
        double averageScore = learningRecordRepository.getAverageScoreByStudentId(studentId)
            .orElse(0.0);
        
        int totalLessons = records.size();
        int completedLessons = (int) records.stream()
            .filter(r -> r.getStatus() == RecordStatus.COMPLETED)
            .count();
        
        return LearningProgressDTO.builder()
            .totalLessons(totalLessons)
            .completedLessons(completedLessons)
            .averageScore(averageScore)
            .recentRecords(records.stream()
                .limit(10)
                .map(this::convertToLearningRecordDTO)
                .collect(Collectors.toList()))
            .build();
    }
    
    private LearningPlanDTO generateNewLearningPlan(String studentId) {
        // 使用AI服务生成个性化学习计划
        String planData = aiService.generateLearningPlan(studentId);
        
        LearningPlan plan = new LearningPlan();
        plan.setStudentId(studentId);
        plan.setSubject("数学"); // 默认科目
        plan.setGradeLevel("小学"); // 默认年级
        plan.setPlanData(planData);
        plan.setStatus(PlanStatus.ACTIVE);
        
        plan = learningPlanRepository.save(plan);
        
        return convertToLearningPlanDTO(plan);
    }
    
    private float calculateProgress(LearningRecord record, AnswerEvaluationResult evaluation) {
        // 根据评估结果计算进度
        float currentProgress = record.getProgress();
        float increment = evaluation.isCorrect() ? 20.0f : 5.0f;
        return Math.min(currentProgress + increment, 100.0f);
    }
    
    private LearningPlanDTO convertToLearningPlanDTO(LearningPlan plan) {
        return LearningPlanDTO.builder()
            .id(plan.getId())
            .studentId(plan.getStudentId())
            .subject(plan.getSubject())
            .gradeLevel(plan.getGradeLevel())
            .planData(JsonUtils.fromJson(plan.getPlanData(), Object.class))
            .status(plan.getStatus())
            .createdAt(plan.getCreatedAt())
            .build();
    }
    
    private LessonDTO convertToLessonDTO(Lesson lesson) {
        return LessonDTO.builder()
            .id(lesson.getId())
            .title(lesson.getTitle())
            .content(lesson.getContent())
            .lessonData(JsonUtils.fromJson(lesson.getLessonData(), Object.class))
            .duration(lesson.getDuration())
            .createdAt(lesson.getCreatedAt())
            .build();
    }
    
    private LearningRecordDTO convertToLearningRecordDTO(LearningRecord record) {
        return LearningRecordDTO.builder()
            .id(record.getId())
            .studentId(record.getStudentId())
            .lessonId(record.getLessonId())
            .startTime(record.getStartTime())
            .endTime(record.getEndTime())
            .progress(record.getProgress())
            .score(record.getScore())
            .status(record.getStatus())
            .build();
    }
}
```

### 2.3 AI服务模块

#### 2.3.1 AI服务接口
```java
// service/AIService.java
@Service
public class AIService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @Value("${ai.service.url}")
    private String aiServiceUrl;
    
    public AIResponseDTO chat(ChatRequestDTO request) {
        try {
            String url = aiServiceUrl + "/chat";
            
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            
            HttpEntity<ChatRequestDTO> entity = new HttpEntity<>(request, headers);
            
            ResponseEntity<AIResponseDTO> response = restTemplate.postForEntity(
                url, entity, AIResponseDTO.class);
            
            return response.getBody();
        } catch (Exception e) {
            throw new CustomException("AI服务调用失败: " + e.getMessage());
        }
    }
    
    public ImageAnalysisDTO analyzeImage(MultipartFile image, String studentId) {
        try {
            String url = aiServiceUrl + "/image/analyze";
            
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.MULTIPART_FORM_DATA);
            
            MultiValueMap<String, Object> body = new LinkedMultiValueMap<>();
            body.add("image", new MultipartInputStreamFileResource(image.getInputStream(), image.getOriginalFilename()));
            body.add("studentId", studentId);
            
            HttpEntity<MultiValueMap<String, Object>> entity = new HttpEntity<>(body, headers);
            
            ResponseEntity<ImageAnalysisDTO> response = restTemplate.postForEntity(
                url, entity, ImageAnalysisDTO.class);
            
            return response.getBody();
        } catch (Exception e) {
            throw new CustomException("图片分析失败: " + e.getMessage());
        }
    }
    
    public VoiceResultDTO processVoice(MultipartFile audio, String studentId) {
        try {
            String url = aiServiceUrl + "/voice/process";
            
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.MULTIPART_FORM_DATA);
            
            MultiValueMap<String, Object> body = new LinkedMultiValueMap<>();
            body.add("audio", new MultipartInputStreamFileResource(audio.getInputStream(), audio.getOriginalFilename()));
            body.add("studentId", studentId);
            
            HttpEntity<MultiValueMap<String, Object>> entity = new HttpEntity<>(body, headers);
            
            ResponseEntity<VoiceResultDTO> response = restTemplate.postForEntity(
                url, entity, VoiceResultDTO.class);
            
            return response.getBody();
        } catch (Exception e) {
            throw new CustomException("语音处理失败: " + e.getMessage());
        }
    }
    
    public AnswerEvaluationResult evaluateAnswer(String question, String answer) {
        try {
            String url = aiServiceUrl + "/evaluate";
            
            Map<String, String> requestBody = new HashMap<>();
            requestBody.put("question", question);
            requestBody.put("answer", answer);
            
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            
            HttpEntity<Map<String, String>> entity = new HttpEntity<>(requestBody, headers);
            
            ResponseEntity<AnswerEvaluationResult> response = restTemplate.postForEntity(
                url, entity, AnswerEvaluationResult.class);
            
            return response.getBody();
        } catch (Exception e) {
            throw new CustomException("答案评估失败: " + e.getMessage());
        }
    }
    
    public String generateLearningPlan(String studentId) {
        try {
            String url = aiServiceUrl + "/generate-plan";
            
            Map<String, String> requestBody = new HashMap<>();
            requestBody.put("studentId", studentId);
            
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            
            HttpEntity<Map<String, String>> entity = new HttpEntity<>(requestBody, headers);
            
            ResponseEntity<Map> response = restTemplate.postForEntity(
                url, entity, Map.class);
            
            return JsonUtils.toJson(response.getBody());
        } catch (Exception e) {
            throw new CustomException("学习计划生成失败: " + e.getMessage());
        }
    }
}
```

#### 2.3.2 Controller
```java
// controller/AIController.java
@RestController
@RequestMapping("/api/ai")
public class AIController {
    
    @Autowired
    private AIService aiService;
    
    @PostMapping("/chat")
    public ResponseEntity<AIResponseDTO> chat(@Valid @RequestBody ChatRequestDTO request) {
        AIResponseDTO response = aiService.chat(request);
        return ResponseEntity.ok(response);
    }
    
    @PostMapping("/image/analyze")
    public ResponseEntity<ImageAnalysisDTO> analyzeImage(
            @RequestParam("image") MultipartFile image,
            @RequestParam("studentId") String studentId) {
        ImageAnalysisDTO result = aiService.analyzeImage(image, studentId);
        return ResponseEntity.ok(result);
    }
    
    @PostMapping("/voice/process")
    public ResponseEntity<VoiceResultDTO> processVoice(
            @RequestParam("audio") MultipartFile audio,
            @RequestParam("studentId") String studentId) {
        VoiceResultDTO result = aiService.processVoice(audio, studentId);
        return ResponseEntity.ok(result);
    }
}
```

## 3. 安全配置

### 3.1 JWT工具类
```java
// security/JwtUtil.java
@Component
public class JwtUtil {
    
    @Value("${jwt.secret}")
    private String secret;
    
    @Value("${jwt.expiration}")
    private Long expiration;
    
    public String generateToken(User user) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", user.getId());
        claims.put("username", user.getUsername());
        claims.put("userType", user.getUserType());
        
        return createToken(claims, user.getUsername());
    }
    
    private String createToken(Map<String, Object> claims, String subject) {
        return Jwts.builder()
            .setClaims(claims)
            .setSubject(subject)
            .setIssuedAt(new Date(System.currentTimeMillis()))
            .setExpiration(new Date(System.currentTimeMillis() + expiration * 1000))
            .signWith(SignatureAlgorithm.HS512, secret)
            .compact();
    }
    
    public String getUsernameFromToken(String token) {
        return getClaimFromToken(token, Claims::getSubject);
    }
    
    public String getUserIdFromToken(String token) {
        return getClaimFromToken(token, claims -> claims.get("userId", String.class));
    }
    
    public Date getExpirationDateFromToken(String token) {
        return getClaimFromToken(token, Claims::getExpiration);
    }
    
    public <T> T getClaimFromToken(String token, Function<Claims, T> claimsResolver) {
        final Claims claims = getAllClaimsFromToken(token);
        return claimsResolver.apply(claims);
    }
    
    private Claims getAllClaimsFromToken(String token) {
        return Jwts.parser()
            .setSigningKey(secret)
            .parseClaimsJws(token)
            .getBody();
    }
    
    public Boolean isTokenExpired(String token) {
        final Date expiration = getExpirationDateFromToken(token);
        return expiration.before(new Date());
    }
    
    public Boolean validateToken(String token, UserDetails userDetails) {
        final String username = getUsernameFromToken(token);
        return (username.equals(userDetails.getUsername()) && !isTokenExpired(token));
    }
}
```

### 3.2 安全配置
```java
// config/SecurityConfig.java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
public class SecurityConfig {
    
    @Autowired
    private JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;
    
    @Autowired
    private JwtRequestFilter jwtRequestFilter;
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(csrf -> csrf.disable())
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/api/auth/**").permitAll()
                .requestMatchers("/api/public/**").permitAll()
                .requestMatchers("/actuator/**").permitAll()
                .requestMatchers("/swagger-ui/**").permitAll()
                .requestMatchers("/v3/api-docs/**").permitAll()
                .anyRequest().authenticated()
            )
            .exceptionHandling(ex -> ex
                .authenticationEntryPoint(jwtAuthenticationEntryPoint)
            )
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            );
        
        http.addFilterBefore(jwtRequestFilter, UsernamePasswordAuthenticationFilter.class);
        
        return http.build();
    }
}
```

### 3.3 JWT过滤器
```java
// security/JwtRequestFilter.java
@Component
public class JwtRequestFilter extends OncePerRequestFilter {
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                  HttpServletResponse response, 
                                  FilterChain chain) throws ServletException, IOException {
        
        final String requestTokenHeader = request.getHeader("Authorization");
        
        String username = null;
        String jwtToken = null;
        
        if (requestTokenHeader != null && requestTokenHeader.startsWith("Bearer ")) {
            jwtToken = requestTokenHeader.substring(7);
            try {
                username = jwtUtil.getUsernameFromToken(jwtToken);
            } catch (IllegalArgumentException e) {
                logger.error("Unable to get JWT Token");
            } catch (ExpiredJwtException e) {
                logger.error("JWT Token has expired");
            }
        }
        
        if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
            UserDetails userDetails = this.userDetailsService.loadUserByUsername(username);
            
            if (jwtUtil.validateToken(jwtToken, userDetails)) {
                UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = 
                    new UsernamePasswordAuthenticationToken(
                        userDetails, null, userDetails.getAuthorities());
                usernamePasswordAuthenticationToken
                    .setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken);
            }
        }
        chain.doFilter(request, response);
    }
}
```

## 4. 数据库配置

### 4.1 数据库配置
```java
// config/DatabaseConfig.java
@Configuration
@EnableJpaRepositories(basePackages = "com.aiteacher.repository")
@EnableTransactionManagement
public class DatabaseConfig {
    
    @Bean
    @ConfigurationProperties("spring.datasource")
    public DataSource dataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactory(
            DataSource dataSource, 
            JpaVendorAdapter jpaVendorAdapter) {
        LocalContainerEntityManagerFactoryBean em = new LocalContainerEntityManagerFactoryBean();
        em.setDataSource(dataSource);
        em.setPackagesToScan("com.aiteacher.entity");
        em.setJpaVendorAdapter(jpaVendorAdapter);
        
        Properties properties = new Properties();
        properties.setProperty("hibernate.hbm2ddl.auto", "update");
        properties.setProperty("hibernate.dialect", "org.hibernate.dialect.MySQL8Dialect");
        properties.setProperty("hibernate.show_sql", "true");
        properties.setProperty("hibernate.format_sql", "true");
        
        em.setJpaProperties(properties);
        return em;
    }
    
    @Bean
    public JpaTransactionManager transactionManager(EntityManagerFactory entityManagerFactory) {
        JpaTransactionManager transactionManager = new JpaTransactionManager();
        transactionManager.setEntityManagerFactory(entityManagerFactory);
        return transactionManager;
    }
}
```

### 4.2 Redis配置
```java
// config/RedisConfig.java
@Configuration
@EnableCaching
public class RedisConfig {
    
    @Bean
    public LettuceConnectionFactory redisConnectionFactory() {
        return new LettuceConnectionFactory();
    }
    
    @Bean
    public RedisTemplate<String, String> redisTemplate() {
        RedisTemplate<String, String> template = new RedisTemplate<>();
        template.setConnectionFactory(redisConnectionFactory());
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new StringRedisSerializer());
        return template;
    }
    
    @Bean
    public CacheManager cacheManager() {
        RedisCacheManager.Builder builder = RedisCacheManager
            .RedisCacheManagerBuilder
            .fromConnectionFactory(redisConnectionFactory())
            .cacheDefaults(cacheConfiguration());
        return builder.build();
    }
    
    private RedisCacheConfiguration cacheConfiguration() {
        return RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(60))
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer()));
    }
}
```

## 5. 异常处理

### 5.1 全局异常处理器
```java
// exception/GlobalExceptionHandler.java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    private static final Logger logger = LoggerFactory.getLogger(GlobalExceptionHandler.class);
    
    @ExceptionHandler(CustomException.class)
    public ResponseEntity<ErrorResponseDTO> handleCustomException(CustomException e) {
        logger.error("Custom exception: {}", e.getMessage());
        
        ErrorResponseDTO errorResponse = ErrorResponseDTO.builder()
            .code(e.getCode())
            .message(e.getMessage())
            .timestamp(LocalDateTime.now())
            .build();
        
        return ResponseEntity.status(e.getHttpStatus()).body(errorResponse);
    }
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorResponseDTO> handleValidationException(MethodArgumentNotValidException e) {
        logger.error("Validation exception: {}", e.getMessage());
        
        String message = e.getBindingResult().getFieldErrors().stream()
            .map(FieldError::getDefaultMessage)
            .collect(Collectors.joining(", "));
        
        ErrorResponseDTO errorResponse = ErrorResponseDTO.builder()
            .code("VALIDATION_ERROR")
            .message(message)
            .timestamp(LocalDateTime.now())
            .build();
        
        return ResponseEntity.badRequest().body(errorResponse);
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponseDTO> handleGenericException(Exception e) {
        logger.error("Unexpected error: {}", e.getMessage(), e);
        
        ErrorResponseDTO errorResponse = ErrorResponseDTO.builder()
            .code("INTERNAL_ERROR")
            .message("内部服务器错误")
            .timestamp(LocalDateTime.now())
            .build();
        
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(errorResponse);
    }
}
```

### 5.2 自定义异常
```java
// exception/CustomException.java
public class CustomException extends RuntimeException {
    
    private final String code;
    private final HttpStatus httpStatus;
    
    public CustomException(String message) {
        super(message);
        this.code = "CUSTOM_ERROR";
        this.httpStatus = HttpStatus.BAD_REQUEST;
    }
    
    public CustomException(String code, String message) {
        super(message);
        this.code = code;
        this.httpStatus = HttpStatus.BAD_REQUEST;
    }
    
    public CustomException(String code, String message, HttpStatus httpStatus) {
        super(message);
        this.code = code;
        this.httpStatus = httpStatus;
    }
    
    public String getCode() {
        return code;
    }
    
    public HttpStatus getHttpStatus() {
        return httpStatus;
    }
}
```

## 6. 配置管理

### 6.1 应用配置
```yaml
# application.yml
server:
  port: 8080
  servlet:
    context-path: /api

spring:
  application:
    name: ai-teacher-backend
  
  datasource:
    url: jdbc:mysql://localhost:3306/ai_teacher?useSSL=false&serverTimezone=UTC
    username: root
    password: password
    driver-class-name: com.mysql.cj.jdbc.Driver
  
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: true
  
  redis:
    host: localhost
    port: 6379
    password: 
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 8
        max-wait: -1ms
        max-idle: 8
        min-idle: 0
  
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB

# JWT配置
jwt:
  secret: mySecretKey
  expiration: 86400 # 24小时

# AI服务配置
ai:
  service:
    url: http://localhost:8000

# 日志配置
logging:
  level:
    com.aiteacher: DEBUG
    org.springframework.security: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: always

# API文档配置
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
```

### 6.2 环境配置
```yaml
# application-dev.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/ai_teacher_dev?useSSL=false&serverTimezone=UTC
    username: root
    password: password
  
  redis:
    host: localhost
    port: 6379

logging:
  level:
    com.aiteacher: DEBUG
```

```yaml
# application-prod.yml
spring:
  datasource:
    url: jdbc:mysql://prod-mysql:3306/ai_teacher?useSSL=true&serverTimezone=UTC
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
  
  redis:
    host: ${REDIS_HOST}
    port: ${REDIS_PORT}
    password: ${REDIS_PASSWORD}

logging:
  level:
    com.aiteacher: INFO
    root: WARN
```

## 7. 测试策略

### 7.1 单元测试
```java
// test/service/AuthServiceTest.java
@ExtendWith(MockitoExtension.class)
class AuthServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @Mock
    private PasswordEncoder passwordEncoder;
    
    @Mock
    private JwtUtil jwtUtil;
    
    @Mock
    private RedisTemplate<String, String> redisTemplate;
    
    @InjectMocks
    private AuthService authService;
    
    @Test
    void testLogin_Success() {
        // Given
        String username = "testuser";
        String password = "testpass";
        String hashedPassword = "hashedpass";
        String token = "jwt-token";
        
        User user = new User();
        user.setId("1");
        user.setUsername(username);
        user.setPasswordHash(hashedPassword);
        user.setUserType(UserType.STUDENT);
        
        when(userRepository.findByUsername(username)).thenReturn(Optional.of(user));
        when(passwordEncoder.matches(password, hashedPassword)).thenReturn(true);
        when(jwtUtil.generateToken(user)).thenReturn(token);
        
        // When
        AuthResponseDTO result = authService.login(new LoginRequestDTO(username, password));
        
        // Then
        assertThat(result.getToken()).isEqualTo(token);
        assertThat(result.getUser().getUsername()).isEqualTo(username);
        
        verify(userRepository).findByUsername(username);
        verify(passwordEncoder).matches(password, hashedPassword);
        verify(jwtUtil).generateToken(user);
        verify(redisTemplate).opsForValue().set(eq("token:1"), eq(token), any(Duration.class));
    }
    
    @Test
    void testLogin_UserNotFound() {
        // Given
        String username = "nonexistent";
        String password = "testpass";
        
        when(userRepository.findByUsername(username)).thenReturn(Optional.empty());
        
        // When & Then
        assertThatThrownBy(() -> authService.login(new LoginRequestDTO(username, password)))
            .isInstanceOf(CustomException.class)
            .hasMessage("用户不存在");
    }
    
    @Test
    void testLogin_WrongPassword() {
        // Given
        String username = "testuser";
        String password = "wrongpass";
        String hashedPassword = "hashedpass";
        
        User user = new User();
        user.setId("1");
        user.setUsername(username);
        user.setPasswordHash(hashedPassword);
        
        when(userRepository.findByUsername(username)).thenReturn(Optional.of(user));
        when(passwordEncoder.matches(password, hashedPassword)).thenReturn(false);
        
        // When & Then
        assertThatThrownBy(() -> authService.login(new LoginRequestDTO(username, password)))
            .isInstanceOf(CustomException.class)
            .hasMessage("密码错误");
    }
}
```

### 7.2 集成测试
```java
// test/controller/AuthControllerIntegrationTest.java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
@TestPropertySource(locations = "classpath:application-test.properties")
class AuthControllerIntegrationTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Test
    void testLogin_Success() {
        // Given
        User user = new User();
        user.setUsername("testuser");
        user.setEmail("test@example.com");
        user.setPasswordHash(passwordEncoder.encode("testpass"));
        user.setUserType(UserType.STUDENT);
        userRepository.save(user);
        
        LoginRequestDTO request = new LoginRequestDTO("testuser", "testpass");
        
        // When
        ResponseEntity<AuthResponseDTO> response = restTemplate.postForEntity(
            "/api/auth/login", request, AuthResponseDTO.class);
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().getToken()).isNotNull();
        assertThat(response.getBody().getUser().getUsername()).isEqualTo("testuser");
    }
    
    @Test
    void testRegister_Success() {
        // Given
        RegisterRequestDTO request = new RegisterRequestDTO();
        request.setUsername("newuser");
        request.setEmail("newuser@example.com");
        request.setPassword("newpass");
        request.setName("New User");
        request.setUserType(UserType.STUDENT);
        
        // When
        ResponseEntity<UserDTO> response = restTemplate.postForEntity(
            "/api/auth/register", request, UserDTO.class);
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().getUsername()).isEqualTo("newuser");
        
        // Verify user was saved
        Optional<User> savedUser = userRepository.findByUsername("newuser");
        assertThat(savedUser).isPresent();
    }
}
```

## 8. 部署配置

### 8.1 Docker配置
```dockerfile
# Dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app

COPY target/ai-teacher-backend-1.0.0.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 8.2 Docker Compose
```yaml
# docker-compose.yml
version: '3.8'

services:
  backend:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_USERNAME=root
      - DB_PASSWORD=password
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - mysql
      - redis
    volumes:
      - ./logs:/app/logs
  
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=ai_teacher
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
  
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
  
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - backend

volumes:
  mysql_data:
  redis_data:
```

### 8.3 Nginx配置
```nginx
# nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream backend {
        server backend:8080;
    }
    
    server {
        listen 80;
        
        location /api/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /swagger-ui/ {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
```

## 9. 监控和运维

### 9.1 健康检查
```java
// config/HealthIndicator.java
@Component
public class DatabaseHealthIndicator implements HealthIndicator {
    
    @Autowired
    private DataSource dataSource;
    
    @Override
    public Health health() {
        try (Connection connection = dataSource.getConnection()) {
            if (connection.isValid(1)) {
                return Health.up()
                    .withDetail("database", "Available")
                    .withDetail("validationQuery", "isValid")
                    .build();
            }
        } catch (SQLException e) {
            return Health.down()
                .withDetail("database", "Unavailable")
                .withDetail("error", e.getMessage())
                .build();
        }
        
        return Health.down()
            .withDetail("database", "Unavailable")
            .build();
    }
}
```

### 9.2 日志配置
```xml
<!-- logback-spring.xml -->
<configuration>
    <springProfile name="dev">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>
        
        <root level="DEBUG">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>
    
    <springProfile name="prod">
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>logs/ai-teacher-backend.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                <fileNamePattern>logs/ai-teacher-backend.%d{yyyy-MM-dd}.log</fileNamePattern>
                <maxHistory>30</maxHistory>
            </rollingPolicy>
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>
        
        <root level="INFO">
            <appender-ref ref="FILE"/>
        </root>
    </springProfile>
</configuration>
```

这份后端开发指南涵盖了Spring Boot后端服务的完整实现，包括用户认证、学习管理、AI服务集成、安全配置、数据库设计、测试策略、部署配置等各个方面。按照这个指南，您可以构建一个完整的AI教师系统后端服务。
